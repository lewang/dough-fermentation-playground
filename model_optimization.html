<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dough Playground - Model Optimization</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .nav-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .nav-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #4a5568;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-title:hover {
            color: #667eea;
            transition: color 0.3s ease;
        }
        
        .hamburger {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .hamburger:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: #4a5568;
            margin: 3px 0;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 250px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: block;
            padding: 15px 20px;
            color: #4a5568;
            text-decoration: none;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s ease;
            font-weight: 500;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #f7fafc;
            color: #667eea;
        }
        
        .dropdown-item.active {
            background: #667eea;
            color: white;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .model-test { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .good { border-color: #4caf50; background: #f1f8e9; }
        .bad { border-color: #f44336; background: #ffebee; }
        .medium { border-color: #ff9800; background: #fff3e0; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: center; 
        }
        th { background: #f5f5f5; }
        .optimize-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .optimize-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .results { margin-top: 20px; }
        .best-model { 
            background: #e8f5e8; 
            padding: 15px; 
            border: 2px solid #4caf50; 
            border-radius: 5px; 
            margin: 20px 0; 
        }
    </style>
</head>
<body>
    <nav class="nav-header">
        <div class="nav-container">
            <a href="index.html" class="nav-title">
                üçû‚ú® Dough Playground ‚ú®ü•ñ
            </a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="index.html" class="dropdown-item">üß™ Fermentation Predictor</a>
                    <a href="model_optimization.html" class="dropdown-item active">üìä Model Optimization</a>
                    <a href="advanced_models.html" class="dropdown-item">ü§ñ Advanced Models</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
        <h1>üî¨ Fermentation Model Optimization</h1>
        
        <div class="model-test">
            <h3>Current Model Performance</h3>
            <p><strong>Arrhenius Model:</strong> Time = A √ó exp(Ea/(R√óT)) √ó (Yeast%)^(-n)</p>
            <p>Current parameters: A = 2.5√ó10‚Åª‚Å∏, Ea = 45,000 J/mol, n = 0.6</p>
            <div id="currentModelResults"></div>
        </div>

        <button class="optimize-btn" onclick="testCurrentModel()">Test Current Model</button>
        <button class="optimize-btn" onclick="optimizeModel()">Optimize Model Parameters</button>
        <button class="optimize-btn" onclick="testAlternativeModels()">Test Alternative Models</button>
        
        <div id="results" class="results"></div>
        
        <div id="bestModel" class="best-model" style="display: none;">
            <h3>üèÜ Best Model Found</h3>
            <div id="bestModelContent"></div>
            </div>
        </div>
    </div>

    <script>
        function toggleMenu() {
            const hamburger = document.querySelector('.hamburger');
            const menu = document.getElementById('dropdownMenu');
            
            hamburger.classList.toggle('active');
            menu.classList.toggle('show');
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const hamburger = document.querySelector('.hamburger');
            const menu = document.getElementById('dropdownMenu');
            
            if (!hamburger.contains(event.target)) {
                hamburger.classList.remove('active');
                menu.classList.remove('show');
            }
        });
        
        // CSV data (same as main webapp)
        const yeastConcentrations = [0.004, 0.008, 0.013, 0.021, 0.032, 0.042, 0.053, 0.063, 0.074, 0.084, 0.126, 0.168, 0.210, 0.252, 0.294, 0.336, 0.420];
        const temperatures = [1.7, 2.2, 2.8, 3.3, 3.9, 4.4, 5.0, 5.6, 6.1, 6.7, 7.2, 7.8, 8.3, 8.9, 9.4, 10.0, 10.6, 11.1, 11.7, 12.2, 12.8, 13.3, 13.9, 14.4, 15.0, 15.6, 16.1, 16.7, 17.2, 17.8, 18.3, 18.9, 19.4, 20.0, 20.6, 21.1, 21.7, 22.2, 22.8, 23.3, 23.9, 24.4, 25.0, 25.6, 26.1, 26.7, 27.2, 27.8, 28.3, 28.9, 29.4, 30.0, 30.6, 31.1, 31.7, 32.2, 32.8, 33.3, 33.9, 34.4, 35.0];
        
        const fermentationData = [
            [null,null,null,null,null,null,null,null,null,null,167,136,115,101,90,82,70], // 1.7¬∞C
            [null,null,null,null,null,null,null,null,null,null,149,121,103,90,80,73,62], // 2.2¬∞C
            [null,null,null,null,null,null,null,null,null,null,133,108,92,80,72,65,55], // 2.8¬∞C
            [null,null,null,null,null,null,null,null,null,161,120,97,82,72,65,59,50], // 3.3¬∞C
            [null,null,null,null,null,null,null,null,159,145,108,87,74,65,58,53,40], // 3.9¬∞C
            [null,null,null,null,null,null,null,161,144,130,97,79,67,59,52,48,37], // 4.4¬∞C
            [null,null,null,null,null,null,166,145,130,118,88,71,61,53,47,43,33], // 5.0¬∞C
            [null,null,null,null,null,null,151,132,118,107,80,65,55,48,43,39,30], // 5.6¬∞C
            [null,null,null,null,null,161,137,120,107,97,72,59,50,44,39,35,27], // 6.1¬∞C
            [null,null,null,null,null,147,125,109,98,88,66,53,45,40,36,32,25], // 6.7¬∞C
            [null,null,null,null,165,134,114,100,89,81,60,49,41,36,32,29,23], // 7.2¬∞C
            [null,null,null,null,151,122,104,91,81,74,55,45,38,33,30,27,19], // 7.8¬∞C
            [null,null,null,null,138,112,95,83,74,67,50,41,35,30,27,25,18], // 8.3¬∞C
            [null,null,null,null,126,102,87,76,68,62,46,37,32,28,25,23,16], // 8.9¬∞C
            [null,null,null,156,116,94,80,70,63,57,42,34,29,26,23,21,15], // 9.4¬∞C
            [null,null,null,143,107,86,74,64,58,52,39,32,27,23,21,19,14], // 10.0¬∞C
            [null,null,null,132,98,80,68,59,53,48,36,29,25,22,19,18,13], // 10.6¬∞C
            [null,null,null,122,90,73,62,55,49,44,33,27,23,20,18,16,11], // 11.1¬∞C
            [null,null,163,112,84,68,58,50,45,41,30,25,21,18,16,15,10], // 11.7¬∞C
            [null,null,150,104,77,63,53,47,42,38,28,23,19,17,15,14,9], // 12.2¬∞C
            [null,null,139,96,71,58,49,43,39,35,26,21,18,16,14,13,9], // 12.8¬∞C
            [null,null,129,89,66,54,46,40,36,32,24,20,17,15,13,12,8], // 13.3¬∞C
            [null,161,120,82,61,50,42,37,33,30,22,18,15,14,12,11,7], // 13.9¬∞C
            [null,149,111,77,57,46,39,34,31,28,21,17,14,13,11,10,7], // 14.4¬∞C
            [null,139,103,71,53,43,37,32,29,26,19,16,13,12,10,9,6], // 15.0¬∞C
            [null,129,96,66,49,40,34,30,27,24,18,15,12,11,10,9,6], // 15.6¬∞C
            [null,120,90,62,46,37,32,28,25,22,17,14,12,10,9,8,5], // 16.1¬∞C
            [null,112,83,58,43,35,30,26,23,21,16,13,11,9,8,8,5], // 16.7¬∞C
            [null,105,78,54,40,32,28,24,22,20,15,12,10,9,8,7,5], // 17.2¬∞C
            [162,98,73,50,37,30,26,23,20,18,14,11,9,8,7,7,4], // 17.8¬∞C
            [152,92,68,47,35,28,24,21,19,17,13,10,9,8,7,6,4], // 18.3¬∞C
            [142,86,64,44,33,27,23,20,18,16,12,10,8,7,6,6,3], // 18.9¬∞C
            [133,80,60,41,31,25,21,19,17,15,11,9,8,7,6,5,3], // 19.4¬∞C
            [120,73,54,37,28,22,19,17,15,14,10,8,7,6,5,5,3], // 20.0¬∞C
            [109,66,49,34,25,20,17,15,14,12,9,7,6,6,5,4,3], // 20.6¬∞C
            [99,60,45,31,23,19,16,14,12,11,8,7,6,5,4,4,2], // 21.1¬∞C
            [90,55,41,28,21,17,14,13,11,10,8,6,5,5,4,4,2], // 21.7¬∞C
            [83,50,37,26,19,15,13,12,10,9,7,6,5,4,4,3,2], // 22.2¬∞C
            [76,46,34,24,18,14,12,11,9,9,6,5,4,4,3,3,2], // 22.8¬∞C
            [70,42,32,22,16,13,11,10,9,8,6,5,4,4,3,3,2], // 23.3¬∞C
            [65,39,29,20,15,12,10,9,8,7,5,4,4,3,3,3,2], // 23.9¬∞C
            [60,36,27,19,14,11,10,8,7,7,5,4,3,3,3,2,2], // 24.4¬∞C
            [56,34,25,17,13,10,9,8,7,6,5,4,3,3,3,2,2], // 25.0¬∞C
            [52,31,23,16,12,10,8,7,6,6,4,4,3,3,2,2,2], // 25.6¬∞C
            [48,29,22,15,11,9,8,7,6,5,4,3,3,2,2,2,2], // 26.1¬∞C
            [45,27,20,14,10,8,7,6,6,5,4,3,3,2,2,2,2], // 26.7¬∞C
            [42,26,19,13,10,8,7,6,5,5,4,3,2,2,2,2,2], // 27.2¬∞C
            [40,24,18,12,9,7,6,6,5,5,3,3,2,2,2,2,2], // 27.8¬∞C
            [38,23,17,12,9,7,6,5,5,4,3,3,2,2,2,2,2], // 28.3¬∞C
            [36,21,16,11,8,7,6,5,4,4,3,2,2,2,2,2,2], // 28.9¬∞C
            [34,20,15,10,8,6,5,5,4,4,3,2,2,2,2,2,2], // 29.4¬∞C
            [32,19,14,10,7,6,5,4,4,4,3,2,2,2,2,2,2], // 30.0¬∞C
            [30,18,14,9,7,6,5,4,4,3,3,2,2,2,2,2,2], // 30.6¬∞C
            [29,18,13,9,7,5,5,4,4,3,2,2,2,2,2,2,2], // 31.1¬∞C
            [28,17,13,9,6,5,4,4,3,3,2,2,2,2,2,2,2], // 31.7¬∞C
            [27,16,12,8,6,5,4,4,3,3,2,2,2,2,2,2,2], // 32.2¬∞C
            [26,16,12,8,6,5,4,4,3,3,2,2,2,2,2,2,2], // 32.8¬∞C
            [25,15,11,8,6,5,4,3,3,3,2,2,2,2,2,2,2], // 33.3¬∞C
            [24,15,11,7,6,5,4,3,3,3,2,2,2,2,2,2,2], // 33.9¬∞C
            [23,14,10,7,5,4,4,3,3,3,2,2,2,2,2,2,2], // 34.4¬∞C
            [22,13,10,7,5,4,4,3,3,2,2,2,2,2,2,2,2]  // 35.0¬∞C
        ];

        // Extract all valid data points
        function getValidDataPoints() {
            const dataPoints = [];
            for (let tempIdx = 0; tempIdx < temperatures.length; tempIdx++) {
                for (let yeastIdx = 0; yeastIdx < yeastConcentrations.length; yeastIdx++) {
                    const time = fermentationData[tempIdx][yeastIdx];
                    if (time !== null) {
                        dataPoints.push({
                            temp: temperatures[tempIdx],
                            yeast: yeastConcentrations[yeastIdx],
                            time: time
                        });
                    }
                }
            }
            return dataPoints;
        }

        // Model functions
        function arrheniusModel(temp, yeast, A, Ea, n, R = 8.314) {
            const tempK = temp + 273.15;
            return A * Math.exp(Ea / (R * tempK)) * Math.pow(yeast, -n);
        }

        function powerLawModel(temp, yeast, a, b, c) {
            return a * Math.pow(temp, b) * Math.pow(yeast, c);
        }

        function polynomialModel(temp, yeast, a, b, c, d, e, f) {
            return a + b*temp + c*yeast + d*temp*temp + e*yeast*yeast + f*temp*yeast;
        }

        function exponentialModel(temp, yeast, a, b, c) {
            return a * Math.exp(b/temp) * Math.pow(yeast, c);
        }

        // Calculate model performance
        function calculatePerformance(dataPoints, modelFunc, params) {
            let totalError = 0;
            let totalSquaredError = 0;
            let totalAbsError = 0;
            let validPredictions = 0;

            const errors = [];

            for (const point of dataPoints) {
                try {
                    const predicted = modelFunc(point.temp, point.yeast, ...params);
                    if (isFinite(predicted) && predicted > 0) {
                        const error = predicted - point.time;
                        const absError = Math.abs(error);
                        const percentError = (absError / point.time) * 100;
                        
                        errors.push({
                            temp: point.temp,
                            yeast: point.yeast,
                            actual: point.time,
                            predicted: predicted,
                            error: error,
                            absError: absError,
                            percentError: percentError
                        });

                        totalError += error;
                        totalSquaredError += error * error;
                        totalAbsError += absError;
                        validPredictions++;
                    }
                } catch (e) {
                    // Skip invalid predictions
                }
            }

            if (validPredictions === 0) return null;

            const meanError = totalError / validPredictions;
            const rmse = Math.sqrt(totalSquaredError / validPredictions);
            const mae = totalAbsError / validPredictions;
            
            // Calculate R-squared
            const meanActual = dataPoints.reduce((sum, p) => sum + p.time, 0) / dataPoints.length;
            let totalSumSquares = 0;
            for (const error of errors) {
                totalSumSquares += Math.pow(error.actual - meanActual, 2);
            }
            const rSquared = 1 - (totalSquaredError / totalSumSquares);

            return {
                meanError,
                rmse,
                mae,
                rSquared,
                validPredictions,
                errors: errors.sort((a, b) => b.percentError - a.percentError)
            };
        }

        function testCurrentModel() {
            const dataPoints = getValidDataPoints();
            const params = [2.5e-8, 45000, 0.6]; // A, Ea, n
            const performance = calculatePerformance(dataPoints, arrheniusModel, params);
            
            let html = `
                <h4>Current Arrhenius Model Performance:</h4>
                <p><strong>Parameters:</strong> A = ${params[0]}, Ea = ${params[1]} J/mol, n = ${params[2]}</p>
                <p><strong>RMSE:</strong> ${performance.rmse.toFixed(2)} hours</p>
                <p><strong>MAE:</strong> ${performance.mae.toFixed(2)} hours</p>
                <p><strong>R¬≤:</strong> ${performance.rSquared.toFixed(4)}</p>
                <p><strong>Valid Predictions:</strong> ${performance.validPredictions}/${dataPoints.length}</p>
                
                <h5>Worst Predictions (highest % error):</h5>
                <table>
                    <tr><th>Temp¬∞C</th><th>Yeast%</th><th>Actual</th><th>Predicted</th><th>Error</th><th>% Error</th></tr>
            `;
            
            for (let i = 0; i < Math.min(10, performance.errors.length); i++) {
                const error = performance.errors[i];
                html += `<tr>
                    <td>${error.temp}</td>
                    <td>${error.yeast}</td>
                    <td>${error.actual}</td>
                    <td>${error.predicted.toFixed(1)}</td>
                    <td>${error.error.toFixed(1)}</td>
                    <td>${error.percentError.toFixed(1)}%</td>
                </tr>`;
            }
            html += '</table>';
            
            document.getElementById('currentModelResults').innerHTML = html;
        }

        function optimizeModel() {
            const dataPoints = getValidDataPoints();
            let bestParams = null;
            let bestScore = Infinity;
            let bestPerformance = null;

            document.getElementById('results').innerHTML = '<p>üîÑ Optimizing parameters... This may take a moment.</p>';

            // Grid search for better parameters
            const AValues = [1e-9, 5e-9, 1e-8, 2.5e-8, 5e-8, 1e-7];
            const EaValues = [30000, 35000, 40000, 45000, 50000, 55000, 60000];
            const nValues = [0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];

            setTimeout(() => {
                for (const A of AValues) {
                    for (const Ea of EaValues) {
                        for (const n of nValues) {
                            const params = [A, Ea, n];
                            const performance = calculatePerformance(dataPoints, arrheniusModel, params);
                            
                            if (performance && performance.rmse < bestScore) {
                                bestScore = performance.rmse;
                                bestParams = params;
                                bestPerformance = performance;
                            }
                        }
                    }
                }

                let html = `
                    <div class="model-test ${bestScore < 5 ? 'good' : bestScore < 15 ? 'medium' : 'bad'}">
                        <h3>üéØ Optimized Arrhenius Model</h3>
                        <p><strong>Best Parameters:</strong></p>
                        <ul>
                            <li>A = ${bestParams[0].toExponential(2)}</li>
                            <li>Ea = ${bestParams[1]} J/mol</li>
                            <li>n = ${bestParams[2]}</li>
                        </ul>
                        <p><strong>Performance:</strong></p>
                        <ul>
                            <li>RMSE: ${bestPerformance.rmse.toFixed(2)} hours</li>
                            <li>MAE: ${bestPerformance.mae.toFixed(2)} hours</li>
                            <li>R¬≤: ${bestPerformance.rSquared.toFixed(4)}</li>
                        </ul>
                        
                        <h4>JavaScript Code for Webapp:</h4>
                        <textarea readonly style="width: 100%; height: 60px;">
const A = ${bestParams[0].toExponential(2)};
const Ea = ${bestParams[1]};
const n = ${bestParams[2]};
                        </textarea>
                    </div>
                `;

                document.getElementById('results').innerHTML = html;
                
                // Show best model
                document.getElementById('bestModel').style.display = 'block';
                document.getElementById('bestModelContent').innerHTML = `
                    <p><strong>Optimized Arrhenius Model:</strong></p>
                    <p>Time = ${bestParams[0].toExponential(2)} √ó exp(${bestParams[1]}/(8.314√ó(T+273.15))) √ó (Yeast%)<sup>-${bestParams[2]}</sup></p>
                    <p><strong>RMSE:</strong> ${bestPerformance.rmse.toFixed(2)} hours (vs ${calculatePerformance(dataPoints, arrheniusModel, [2.5e-8, 45000, 0.6]).rmse.toFixed(2)} hours for original)</p>
                `;
            }, 100);
        }

        function testAlternativeModels() {
            const dataPoints = getValidDataPoints();
            let html = '<h3>üß™ Alternative Model Comparison</h3>';

            // Test different models
            const models = [
                {
                    name: 'Current Arrhenius',
                    func: arrheniusModel,
                    params: [2.5e-8, 45000, 0.6],
                    equation: 'Time = 2.5√ó10‚Åª‚Å∏ √ó exp(45000/(8.314√ó(T+273.15))) √ó (Yeast%)‚Åª‚Å∞¬∑‚Å∂'
                },
                {
                    name: 'Power Law',
                    func: powerLawModel,
                    params: [850, -1.8, -0.65],
                    equation: 'Time = 850 √ó T‚Åª¬π¬∑‚Å∏ √ó (Yeast%)‚Åª‚Å∞¬∑‚Å∂‚Åµ'
                },
                {
                    name: 'Simple Exponential',
                    func: exponentialModel,
                    params: [0.001, 1000, -0.5],
                    equation: 'Time = 0.001 √ó exp(1000/T) √ó (Yeast%)‚Åª‚Å∞¬∑‚Åµ'
                }
            ];

            for (const model of models) {
                const performance = calculatePerformance(dataPoints, model.func, model.params);
                if (performance) {
                    const className = performance.rmse < 5 ? 'good' : performance.rmse < 15 ? 'medium' : 'bad';
                    html += `
                        <div class="model-test ${className}">
                            <h4>${model.name}</h4>
                            <p><strong>Equation:</strong> ${model.equation}</p>
                            <p><strong>RMSE:</strong> ${performance.rmse.toFixed(2)} hours | 
                               <strong>R¬≤:</strong> ${performance.rSquared.toFixed(4)} | 
                               <strong>MAE:</strong> ${performance.mae.toFixed(2)} hours</p>
                        </div>
                    `;
                }
            }

            document.getElementById('results').innerHTML = html;
        }

        // Initialize
        window.onload = function() {
            testCurrentModel();
        };
    </script>
</body>
</html>